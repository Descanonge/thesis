
\addbibresource{references/software.bib}
\addbibresource{references/zotero_export.bib}
\addbibresource{references/custom.bib}
\ExecuteBibliographyOptions{
  abbreviate = true,
  dashed = false,
  doi = true,
  eprint = false,
  hyperref = true,
  indexing = bib,
  isbn = false,
  giveninits = true,
  maxnames = 100,
  maxcitenames = 1,
  mergedate = false,
  pluralothers = true,
  % refsection = chapter,
  sorting = nyt,
  sortcites = false,
  uniquename = init,
  url = false,
}

% Add filter for 'normal entries'
\defbibfilter{normal}{%
  not type=software
  and not type=dataset
}

\newcommand{\bibnameDataset}{Références données}

% Sort dataset, software and rest separately
\DeclarePresort[dataset]{dd}
\DeclarePresort[software]{ss}

% Setup bibliography headings
\defbibheading{bibintoc}[\bibname]{%
  \chapter*{#1}%
  \addcontentsline{toc}{chapter}{#1}%
  \markboth{#1}{#1}}
\defbibheading{subbibintoc}[\bibname]{\unsection{#1}}
\defbibheading{subsubbibintoc}[\bibname]{\unsubsection{#1}}

% Remove small caps in family names
\DefineBibliographyExtras{french}{\restorecommand\mkbibnamefamily}

% New bibliography format for dataset entries
\DeclareBibliographyDriver{dataset}{%
  \usebibmacro{begentry}%
  \printfield{shorttitle} -- \printfield{title}% chktex 8
  \newunit\newblock%
  \printnames{author}%
  \newunit%
  \printlist{publisher}%
  \newunit%
  \printfield{year}%
  \newunit\newblock%
  \printfield{doi}%
  \usebibmacro{finentry}%
}

% New bibliography format for software entries
\DeclareBibliographyDriver{software}{%
  \usebibmacro{begentry}%
  \printfield{shorttitle} -- \printfield{title}% chktex 8
  \setunit{\addspace}%
  \printfield{type}%
  \setunit{,\addspace}%
  \printfield{version}%
  \newunit\newblock%
  \printnames{author}%
  \newunit%
  \printlist{publisher}%
  \newunit\newblock
  \printfield{doi}%
  \newunit%
  \printfield{url}%
  \usebibmacro{finentry}%
}

\DeclareSourcemap{
  \maps{
    \map{
      \pertype{software}
      % Set sortkey to shorttitle so that software is sorted by name
      \step[fieldsource=shorttitle]
      \step[fieldset=sortkey, origfieldval]
      % Alias pypi (which is not supported by data model) to doi
      \step[fieldsource=pypi, fieldtarget=doi]
    }
  }
}

\DeclareFieldFormat[software]{type}{\mkbibparens{#1}}
\DeclareFieldFormat[software]{url}{\mkbibacro{url}\addcolon~\url{#1}}
\DeclareFieldFormat[software]{doi}{\mkbibacro{pypi}\addcolon~\href{https://pypi.org/project/#1}{#1}}

% Add abbreviation for version
\DefineBibliographyStrings{french} {%
  version = {ver\adddot},%
}

% Citation command for software
% (too much hassle to rewrite textcite or cite)
\DeclareCiteCommand{citesoft}{}{%
  \printfield[citehyperref]{shorttitle}%
}{, }{}

% Citations commands that are fully hyperlinked

% All citation is hyperlinked
\DeclareFieldFormat{citehyperref}{%
  \DeclareFieldAlias{bibhyperref}{noformat}% Avoid nested links
  \bibhyperref{#1}}

\DeclareFieldFormat{textcitehyperref}{%
  \DeclareFieldAlias{bibhyperref}{noformat}% Avoid nested links
  \bibhyperref{%
    #1%
    \ifbool{cbx:parens}
      {\bibcloseparen\global\boolfalse{cbx:parens}}
      {}}}

\savebibmacro{cite}
\savebibmacro{textcite}

\renewbibmacro*{cite}{%
  \printtext[citehyperref]{%
    \restorebibmacro{cite}%
    \usebibmacro{cite}}}

\renewbibmacro*{textcite}{%
  \ifboolexpr{
    (not test {\iffieldundef{prenote}} and
      test {\ifnumequal{\value{citecount}}{1}})
    or
    (not test {\iffieldundef{postnote}} and
      test {\ifnumequal{\value{citecount}}{\value{citetotal}}})
  }
    {\DeclareFieldAlias{textcitehyperref}{noformat}}
    {}%
  \printtext[textcitehyperref]{%
    \restorebibmacro{textcite}%
    \usebibmacro{textcite}}}
