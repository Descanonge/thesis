\NeedsTeXFormat{LaTeX2e} %chktex 44
\ProvidesPackage{ch-thesis}[2023/02/09 CH Thèse]
\RequirePackage{expl3}
\RequirePackage{xparse}
\RequirePackage{l3keys2e}

\ExplSyntaxOn

\bool_new:N \l_chthesis_print_bool
\keys_define:nn { chthesis } {
  print .bool_set:N = \l_chthesis_print_bool,
  print .default:n = false
}
\keys_set:nn { chthesis } {
  print = false,
}

\ProcessKeysOptions{chthesis}

\NewDocumentCommand \ifdraft { +m +m } {
  \ifdraftdoc #1 \else #2 \fi}

\ExplSyntaxOff % babel no like expl3 :(
\RequirePackage[english,main=french]{babel}

\RequirePackage[T1]{fontenc}
\RequirePackage{fontspec}
\RequirePackage[otfmath, osf]{XCharter}
\RequirePackage[defaultsans]{opensans}
\setmonofont{RobotoMono-Regular}[
Scale = MatchLowercase,
ScaleAgain = 0.96
]

\RequirePackage[babel]{microtype}
% This removes warnings in logs, but
% I have no idea what I'm doing
\SetProtrusion{
  encoding = {TU},
  family = {XCharterMath},
} {}
\SetProtrusion{
  encoding = {TS1},
  family = {XCharter-TLF}
} {}

%%% Localization
\RequirePackage{csquotes}
\frenchsetup{
  ItemLabels=\textendash,
  ThinColonSpace
}
\addto\extrasenglish{\sisetup{locale = US}}
\addto\extrasfrench{\sisetup{locale = FR, output-decimal-marker=.}}

\ExplSyntaxOn

% Insérer du texte anglais, sans et avec guillements
\NewDocumentCommand \eng { m } {
  \foreignlanguage {english} {#1}}

\NewDocumentCommand \engquote{ m } {
  \foreignquote {english} {#1}}

% Guillements à la française ou à l'anglaise (*).
\NewDocumentCommand \guil { s +m }{
  \IfBooleanTF {#1} {
    \enquote* {#2}
  }{
    \enquote {#2}
  }}

% Tirets (cadratins) d'incise
% Utiliser * si la phrase se termine par un tiret (il n'est alors pas inséré)
\NewDocumentCommand \encadra { s +m } {
  \IfBooleanTF {#1} {
    \ ---~#2%
  }{
    \ ---~#2~---%
  }}


% Notes pour relecture
\NewDocumentCommand \review { +m }{
  { \color{red} #1 }
}

\ExplSyntaxOff

%%% Shorthands
\useshorthands*{"}
% Hard hyphen, no breaks (but word after is breakable)
\defineshorthand{"~}{\babelhyphen{nobreak}}
% Hard hyphen, breakable (word after also breakable)
\defineshorthand{"-}{\babelhyphen{hard}}

\RequirePackage{bib-setup}

\RequirePackage{graphicx}
\graphicspath{{resources}}

\RequirePackage{amsmath}
\RequirePackage{geometry}
\RequirePackage{listings}
\RequirePackage{multirow}

\RequirePackage{siunit-setup}

%%% Hyperref
\RequirePackage{hyperref}
\hypersetup{
  hidelinks,
  draft = false,
  unicode = true,
  linktoc = section,
}
\AtEndPreamble{
  \hypersetup{
    pdftitle={\Title},
    pdfauthor={\Author, \Email},
    pdfsubject={\Subject},
    pdfkeywords={\Keywords}
  }
}

\RequirePackage[all]{hypcap}

\RequirePackage{cref-setup}

\RequirePackage{gls-setup}

%%% Bookmarks
\RequirePackage[depth=4]{bookmark}
\bookmarksetup{numbered}

%%% Page style
\chapterstyle{ger}

\ExplSyntaxOn
\makepagestyle {thesis}

\newcommand*\pnumstyle{}

\bool_if:NTF \l_chthesis_print_bool {
  \makeevenfoot{thesis}{\pnumstyle\thepage}{}{}
  \makeoddfoot{thesis}{}{}{\pnumstyle\thepage}
  \makeheadrule{ruled}{\textwidth}{\normalrulethickness}
  \makepsmarks{thesis}{\@ruledmarks}
  \makeevenhead{thesis}{\scshape\leftmark}{}{}
  \makeoddhead{thesis}{}{}{\rightmark}
}{
  \makeevenfoot{thesis}{}{\pnumstyle\thepage}{}
  \makeoddfoot{thesis}{}{\pnumstyle\thepage}{}
  \makeheadrule{ruled}{\textwidth}{\normalrulethickness}
  \makepsmarks{thesis}{\@ruledmarks}
  \makeevenhead{thesis}{\scshape\leftmark}{}{}
  \makeoddhead{thesis}{\scshape\leftmark}{}{}
}
\ExplSyntaxOff

\pagestyle{thesis}

\raggedbottom

\setsecnumdepth{subsubsection}
\renewcommand*\thesection{\arabic{section}} % No chapter number in section
\renewcommand*\thechapter{\Roman{chapter}}

% Figure number with middle dot
% \mainmatter reset things so we have to hack a bit
\renewcommand\@memmain@floats{%
  \counterwithin{figure}{chapter}
  \counterwithin{table}{chapter}
  \def\thefigure{\thechapter\textperiodcentered\textlf{\arabic{figure}}}
  \def\thetable{\thechapter\textperiodcentered\textlf{\arabic{table}}}
}

% Footnote marker in XCharter superior figure style
\renewcommand*\@makefnmark{\textsu{\@thefnmark}}
% and lining figure
\renewcommand{\@makefntextFB}[1]{%
  \def\footscript##1{\textlf{##1}\dotFFN\kernFFN}%
  \setlength{\footmarkwidth}{\FBfnindent}%
  \setlength{\footmarksep}{-\footmarkwidth}%
  \setlength{\footparindent}{\parindentFFN}%
  \makefootmark #1}%

% Equation number in lining style
\renewcommand*\theequation{%
  \ifnum \c@chapter>\z@ \thechapter.\fi \textlf{\arabic{equation}}}

%% Page Layout
% A4 297x210mm (global a4paper option)
\settrims{0pt}{0pt} % no trim needed
% Fix width/height for comfort
\settypeblocksize{230mm}{160mm}{*}
% Upper/Lower margins, fix upper, lower has what's left (enough hopefully)
\setulmargins{3cm}{*}{*}
% Left/Right margins, set ratio so that spine is smaller than edge
\setlrmargins{*}{*}{1.}
% Set header size and foot skip, header taller than baseline for É in sections titles
\setheadfoot{2.\onelineskip}{2\onelineskip}
\setheaderspaces{*}{\onelineskip}{*}
% Check and apply layout
\checkandfixthelayout

%%% Sections styles
\renewcommand*\chaptitlefont{\normalfont\HUGE\bfseries\sffamily}
\renewcommand*\chapnumfont{\normalfont\huge\bfseries\sffamily}
\renewcommand*\chapnamefont{\normalfont\huge\bfseries\sffamily}
\setsecheadstyle{\Large\bfseries\sffamily}
\setsubsecheadstyle{\large\bfseries\sffamily}
\setsubsubsecheadstyle{\bfseries\sffamily}

%%% TOC, contents, lof
% Section numbering and toc options
\renewcommand*\cftchaptername{\chaptername~}
\renewcommand*\cftappendixname{\appendixname~}
\renewcommand*\cftsectionpresnum{\lfstyle}
\renewcommand*\cftsubsectionpresnum{\lfstyle}
\setcounter{lofdepth}{1}
\setcounter{tocdepth}{2}
\setlength{\cftchapterindent}{0pt}
\setlength{\cftchapternumwidth}{1.5em}
\setlength{\cftsectionindent}{1.5em}
\setlength{\cftsectionnumwidth}{1.5em}
\setlength{\cftsubsectionindent}{3em}
\setlength{\cftsubsectionnumwidth}{2.2em}
\setlength{\cftsubsubsectionindent}{5.2em}
\setlength{\cftsubsubsectionnumwidth}{2.8em}
\setlength{\cftfigureindent}{0em}
\setlength{\cftfigurenumwidth}{3em}

\RequirePackage{minitoc}
\mtcsetdepth{minitoc}{3}
\mtcsetfont{minitoc}{section}{\normalfont\small}

% Remove chapter typesetting stuff (we want a simple section instead)
\renewcommand\lofheadstart{}
\renewcommand\printloftitle[1]{\section*{#1}}
\renewcommand\afterloftitle{\thispagestyle{thesis}}
\renewcommand\lofmark{\markboth{}{\listfigurename}}
\setlength{\cftfigureindent}{2.5em}

% New chapter but add it to lof
% Lifted from memoir.cls \@chapter

\ExplSyntaxOn
\NewDocumentCommand \addChpLof {} {
  \ifanappendix
  \addcontentsline{lof}{appendix}{%
    \protect\chapternumberline{\thechapter}\f@rtoc}%
  \else
  \addcontentsline{lof}{chapter}{%
    \protect\chapternumberline{\thechapter}\f@rtoc}%
  \fi
}

%%% Unumbered Sections
% Unumbered section with an entry in the TOC
\newcounter{unsection}[chapter]
\crefalias{unsection}{section}
\newcommand*\unsection[1]{% {name}
  \phantomsection%
  \addcontentsline{toc}{section}{#1}%
  \refstepcounter{unsection}%
  \section*{#1}}

\ExplSyntaxOff

%%% Appendix
% Add 'Annexe' in header
\newcommand*\changeappendixmark{%
  \renewcommand\chaptermark[1]{%
    \markboth{\memUChead{%
        \appendixname\ \thechapter\ --\ ##1}}{}}}

%%% Caption width
\changecaptionwidth%
\captionwidth{0.9\textwidth}

%%% Maths commands

% Some operators
\DeclareMathOperator{\std}{std}
\newcommand*\moy[1]{\langle#1\rangle}
\newcommand*\med[1]{\overline{#1}}
\newcommand*\err[1]{\tilde{#1}}
\newcommand*\norm[1]{\operatorname{norm}\paren{#1}}
\newcommand*\abs[1]{\left|#1\right|}
\newcommand*\paren[1]{\left(#1\right)}
\newcommand*\norme[2][]{% [norme subscript, default none]{argument}
  \left\lVert#2\right\rVert_{#1}}

% Table column types
% automatic math env
\newcolumntype{C}{>{$}c<{$}}
\newcolumntype{R}{>{$}R<{$}}
\newcolumntype{L}{>{$}L<{$}}

% Format a row
% at the column following $, the style is reset
\newcolumntype{$}{>{\global\let\currentrowstyle\relax}}
% the style is applied at the column following ^
\newcolumntype{^}{>{\currentrowstyle}}
\newcommand*\rowstyle[1]{\gdef\currentrowstyle{#1}%
  #1\ignorespaces}

% Quick text stuff
\newcommand*\tot{\text{total}}
\newcommand*\frt{\text{front}}
\newcommand*\bkg{\text{background}}

%%% Datasets commands
% Set the label for the section describing the dataset
% in the methods chapter. The (given) label is the same
% as in the bibliography
\newcommand*\declareDataset[1]{% {biblio label}
  \label{sec:donnees-#1}}
% Use that same label to refer to the section
\newcommand*\datasect[1]{% {biblio label}
  \cref{sec:donnees-#1}}
\newcommand*\dataname[1]{% {biblio label}
  \hyperref[sec:donnees-#1]{\citefield{#1}[citefield]{shorttitle}}}

% Hyperref overrides xcharter definition
% DONT USE IT WHERE IT COULD END IN BOOKMARKS
\renewcommand*\textcircled[1]{%
  \hmode@bgroup%
  \ifnum`#1>`9\relax%
  \def\y{.3ex}\def\x{\scshape\lowercase{#1}}%
  \else%
  \def\y{.19ex}\def\x{\liningnums#1}%
  \fi%
  \mbox{%
    \ooalign{%
      \hfil\raise\y\hbox{\scalefont{.78}\x}\hfil\crcr%
      {\usefont{TS1}{XCharter-TLF}{m}{n}\char79}%\textbigcircle
    }}%
  \egroup}

%%% Framed environments
\usepackage[dvipsnames]{xcolor}

\colorlet{shadecolor-note}{Cerulean!15!white}

\newenvironment{note}{%
  \def\FrameCommand{%
    \fboxsep=\FrameSep \vrule width 1pt \colorbox{shadecolor-note}}% chktex 1
  \MakeFramed{\parindent=0pt\textbf{\sffamily Note}\\[3pt]
    \advance\hsize -\width \FrameRestore}}% chktex 1
{\endMakeFramed}


%%% Captions
\newcommand\captionT[2]{% {Title}{text}
  \caption[#1]{\emph{#1}. #2}}


%%% Article
\newcommand\authorArticle[3][1]{% [affil]{prénom}{nom}
  \bname{#2}\ \bsc{#3}\textsuperscript{#1}}
\newcommand\affil[2][1]{\textsuperscript{#1}{#2}}

\setparaheadstyle{\bfseries\raggedright}
\setsubparaheadstyle{\itshape\raggedright}

\newenvironment{articleBlock}[1]% {name}
{\paragraph{#1.}}{}
\newenvironment{articleSubBlock}[1]% {name}
{\subparagraph{#1.}}{}


\ExplSyntaxOn

% Command for repeating stuff
\NewDocumentCommand {\Repeat} { m +m } {
  \prg_replicate:nn {#1} {#2}
}

% Commands for having nice rules in list of figures
\NewDocumentCommand {\xhrulefill} {O{}} {
  \group_begin:
  \me_xhrulefill:n { #1 }
  \group_end:
}

\keys_define:nn {me/xhrule} {
  height .dim_set:N    = \l_me_xhrule_height_dim,
  thickness .dim_set:N = \l_me_xhrule_thickness_dim,
  fill .skip_set:N     = \l_me_xhrule_fill_skip,
  height .initial:n    = 0pt,
  thickness .initial:n = 0.5pt,
  fill .initial:n      = 0pt plus 1fill,
}

\cs_new_protected:Nn \me_xhrulefill:n {
  \keys_set:nn {me/xhrule} { #1 }
  \leavevmode\leaders\hrule
  height \dim_eval:n { \l_me_xhrule_height_dim + \l_me_xhrule_thickness_dim }
  depth \dim_eval:n { -\l_me_xhrule_height_dim }
  \skip_horizontal:N \l_me_xhrule_fill_skip
  \kern 0pt
}

\newcommand* \insertArticle {
  {
    \cs_set_eq:NN \subsection_old \subsection
    \cs_set:Npn \subsection ##1 {
      \subsection_old {##1}
      \markright{[Article]\ \thesubsection\ ##1}
    }

    \selectlanguage {english}
    \setlength \parindent {0pt}

    \clearpage
    \section {Article:\ \articleTitle}
    \label {sec:article-bg}
    \tl_set:Nn \tl_tmpa_l {[\textit{Pre-print\ Biogeosciences}\ \glsurl{preprint-bgs-doi}]}
    \bool_if:NTF \l_chthesis_print_bool {
      % \renewcommand*\ruledefootc{\tl_tmpa_l}
      % \renewcommand*\ruledofootc{\tl_tmpa_l}
      \makeevenfoot{thesis}{\pnumstyle\thepage}{\tl_tmpa_l}{}
      \makeoddfoot{thesis}{}{}{\tl_tmpa_l}{\pnumstyle\thepage}
    }{
      \makeevenfoot{thesis}{\pnumstyle\thepage}{}{\tl_tmpa_l}
      \makeoddfoot{thesis}{\pnumstyle\thepage}{}{\tl_tmpa_l}
    }

    \addtocontents{lof}{
      \makebox[0.6\textwidth]{Article\ \xhrulefill[height=0.5ex]}}

    \input {tex/article}
    \addtocontents{lof}{
      \makebox[0.6\textwidth]{\xhrulefill[height=1ex]}}
    \clearpage
  }
}

% Font in any size
\NewDocumentCommand \anysize { m O{1.1} +m }{%
  \dim_set:Nn \l_tmpa_dim {#1}
  {\fontsize {#1} {\dim_eval:n{\l_tmpa_dim*#2}} \selectfont #3}
}

\ExplSyntaxOff
