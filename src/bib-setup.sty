\NeedsTeXFormat{LaTeX2e} %chktex 44
\ProvidesPackage{bib-setup}

\RequirePackage[style=authoryear-comp]{biblatex}

\addbibresource{references/software.bib}
\addbibresource{references/zotero_export.bib}
\addbibresource{references/custom.bib}
\ExecuteBibliographyOptions{
  abbreviate = true,
  dashed = false,
  doi = true,
  eprint = false,
  hyperref = true,
  indexing = bib,
  isbn = false,
  giveninits = true,
  maxbibnames = 6,
  minbibnames = 6,
  maxcitenames = 2,
  mincitenames = 1,
  maxsortnames = 2,
  minsortnames = 1,
  mergedate = false,
  pluralothers = false,
  % refsection = chapter,
  sorting = nyt,
  sortcites = false, % watch out, I rely on this (for footnotes for ex.)
  uniquename = mininit,
  uniquelist = minyear,
  url = false
}

% Space between items with different starting letter
\setlength\bibinitsep{\baselineskip}

% Add filter for 'normal entries'
\defbibfilter{normal}{%
  not type=software
  and not type=dataset}

% Sort dataset, software and rest separately
\DeclarePresort[dataset]{dd}
\DeclarePresort[software]{ss}

\newcommand*\bibsoftwareTitle{Logiciels}
\newcommand*\bibdataTitle{Donn√©es}

% Remove small caps in family names
\DefineBibliographyExtras{french}{\restorecommand\mkbibnamefamily}

\savebibmacro{cite}
\savebibmacro{textcite}

% No extra date
\renewbibmacro*{date+extradate}{}%

% Customize bibliography: Start by the 'label', ie the
% citation as it appears in the text
\renewbibmacro*{begentry}{%
  {
    % We are in bibliography but we want maxCITEnames
    \c@maxnames\blx@maxcitenames\relax
    \c@minnames\blx@mincitenames\relax
    % reset some variables to avoid cite to merge
    \global\undef\cbx@lasthash
    \global\undef\cbx@lastyear
    \DeclareFieldAlias{bibhyperref}{noformat}%
    \printtext[bold]{%
      \restorebibmacro{cite}%
      \lfstyle%
      \usebibmacro{cite}\addspace:\space}%
  }
  \c@maxnames\blx@maxbibnames\relax%
  \c@minnames\blx@minbibnames\relax%
% \renewcommand*\mkbibnamefamily[1]{\bname{##1}}%
}

\DeclareFieldFormat
  [software,dataset]
  {title}{\mkbibemph{\textlf{#1}}}
\DeclareFieldFormat
  [article,inbook,incollection,inproceedings,patent,thesis,unpublished]
  {title}{\mkbibquote{#1\isdot}}
\DeclareFieldFormat{version}{\bibstring{version}~{\textosf{#1}}}
\DeclareFieldFormat[dataset,software]{shorttitle}{\textlf{#1}}
\DeclareFieldFormat[dataset,software]{citefield}{\textlf{#1}}

% Change default name format
\DeclareNameAlias{default}{family-given}
\DeclareNameAlias{sortname}{family-given}
\DeclareNameAlias{citename}{family-given}
% Remove comma and put in parens
\renewcommand*\revsdnamepunct{}
\renewcommand*\mkbibnamegiven[1]{\mkbibparens{#1}}

\newbibmacro*{label:dataset}{%
  \printlist{datavar}
  \printfield{shorttitle}\addspace:\space}
\newbibmacro*{label:software}{%
  \printfield{shorttitle}\addspace:\space}

% New bibliography format for dataset entries
\DeclareBibliographyDriver{dataset}{%
  % \usebibmacro{begentry}% only for regular entries
  \printtext[bold]{\usebibmacro{label:dataset}}%
  \printfield{title}%
  \newunit\newblock%
  \printnames{author}%
  \newunit%
  \printlist{publisher}%
  \newunit%
  \printfield{year}%
  \newunit\newblock%
  \printfield{doi}%
  \usebibmacro{finentry}}

% New bibliography format for software entries
\DeclareBibliographyDriver{software}{%
  % \usebibmacro{begentry}% only for regular entries
  \printtext[bold]{\usebibmacro{label:software}}%
  \printfield{title}%
  \setunit{\addspace}%
  \printfield{type}%
  \setunit{,\addspace}%
  \printfield{version}%
  \newunit\newblock{}
  \printnames{author}%
  \newunit%
  \printlist{publisher}%
  \newunit\newblock{}
  \printfield{pypi}%
  \newunit%
  \printfield{url}%
  \usebibmacro{finentry}}

\DeclareSourcemap{
  \maps{
    % Adapt nyt sorting for dataset (datavar, ,shortitle)
    \map{
      \pertype{dataset}
      % Set sortname to datavar
      \step[fieldsource=datavar]
      \step[fieldset=sortname, origfieldval]
      % Set sortyear to a constant (no incidence on sorting)
      \step[fieldset=sortyear, fieldvalue=0]
      % Set sorttitle to shorttitle
      \step[fieldsource=shorttitle]
      \step[fieldset=sorttitle, origfieldval]
    }
    % Sort software by their shorttitle (ie software name)
    \map{
      \pertype{software}
      \step[fieldsource=shorttitle]
      \step[fieldset=sortname, origfieldval]
    }
  }
}

\DeclareFieldFormat[software]{type}{\mkbibparens{#1}}
\DeclareFieldFormat[software]{url}{\mkbibacro{url}\addcolon~\url{#1}}
\DeclareFieldFormat[software]{pypi}{\mkbibacro{pypi}\addcolon~\href{https://pypi.org/project/#1}{#1}}

% Add abbreviation for version
\DefineBibliographyStrings{french}{%
  version = {ver\adddot}}

% Citation command for software
% (too much hassle to rewrite textcite or cite)
\DeclareCiteCommand{citesoft}{}{%
  \printfield[citehyperref]{shorttitle}%
}{, }{}


%%% Hyperlink cite macros
% Citations commands that are fully hyperlinked

\DeclareFieldFormat{citehyperref}{%
  \DeclareFieldAlias{bibhyperref}{noformat}% Avoid nested links
  \bibhyperref{#1}}

\DeclareFieldFormat{textcitehyperref}{%
  \DeclareFieldAlias{bibhyperref}{noformat}% Avoid nested links
  \bibhyperref{%
    #1%
    \ifbool{cbx:parens}
    {\bibcloseparen\global\boolfalse{cbx:parens}}
    {}}}

\renewbibmacro*{cite}{%
  \printtext[citehyperref]{%
    \restorebibmacro{cite}%
    \usebibmacro{cite}}}

\renewbibmacro*{textcite}{%
  \ifboolexpr{%
    (not test {\iffieldundef{prenote}} and
      test {\ifnumequal{\value{citecount}}{1}})
    or
    (not test {\iffieldundef{postnote}} and
      test {\ifnumequal{\value{citecount}}{\value{citetotal}}})
  }%
    {\DeclareFieldAlias{textcitehyperref}{noformat}}
    {}%
  \printtext[textcitehyperref]{%
    \restorebibmacro{textcite}%
    \usebibmacro{textcite}}}
