\documentclass[french, a4paper, 12pt, twoside, openright, draft]{memoir}

\usepackage{geometry}
\usepackage[T1]{fontenc}
\usepackage[otfmath, math-style=upright]{XCharter}

\usepackage[french]{babel}
\usepackage{csquotes}

\usepackage[style=authoryear-comp]{biblatex}

\usepackage{microtype}

\usepackage{xr}
\usepackage{subfiles}
\externaldocument[M-]{\subfix{index}}

% \usepackage[dvipsnames]{xcolor}
\usepackage{siunitx}
\usepackage[depth=4]{bookmark}
\usepackage{graphicx}
\usepackage{listings}
\usepackage{hyperref}

% \let\printglossary\relax
% \let\theglossary\relax
% \let\endtheglossary\relax
\usepackage[
xindy, nogroupskip, nonumberlist,
shortcuts, toc, section=section
]{glossaries-extra}
\setabbreviationstyle[acronym]{short-nolong}

\usepackage{cleveref}

\ifSubfilesClassLoaded{}{\usepackage{minitoc}}


\newcommand\Author{Clément Haëck}
\newcommand\Email{clement.haeck@locean.ipsl.fr}
\newcommand\Title{Impact des fronts sur le Phytoplancton dans la région du Gulf-Stream quantifié par imagerie satellitaire}
\newcommand\Subject{biogeochemistry}
\newcommand\Keywords{}

\chapterstyle{ger}
\pagestyle{ruled}

% A4 297x210mm (global a4paper option)
\settrims{0pt}{0pt} % no trim needed
% Fix width/height for comfort
\settypeblocksize{230mm}{160mm}{*}
% Upper/Lower margins, fix upper, lower has what's left (enough hopefully)
\setulmargins{3cm}{*}{*}
% Left/Right margins, set ratio so that spine is smaller than edge
\setlrmargins{*}{*}{1.3}
% Set header/footer size, header taller than baseline for É in sections titles
\setheadfoot{1.1\onelineskip}{2\onelineskip}
\setheaderspaces{*}{2\onelineskip}{*}
% Check and apply layout
\checkandfixthelayout

\setsecnumdepth{subsection}
\setcounter{tocdepth}{2}
\renewcommand{\cftchaptername}{\chaptername~}
\renewcommand{\cftappendixname}{\appendixname~}
\ifSubfilesClassLoaded{}{\mtcsetfont{minitoc}{section}{\normalfont\small}}


\newcommand{\maketoc}{
  \pdfbookmark[section]{\contentsname}{toc}
  \setlength{\baselineskip}{1.03\onelineskip}
  \tableofcontents*
  \setlength{\baselineskip}{\onelineskip}
}

\newcommand{\tocsubfile}{%
  \ifSubfilesClassLoaded{%
    \printglossary[toctitle=Glossaire]
    \clearpage
    \maketoc
  }{%
    \minitoc
  }
  \newpage
}

\newcommand{\sectiontoc}[1]{%
  \phantomsection
  \addcontentsline{toc}{section}{#1}
  \section*{#1}
}

\graphicspath{{resources/}}

\addbibresource[label=refs]{texbuild/processed.bib}
\ExecuteBibliographyOptions{
  hyperref=true, indexing=bib, uniquename=init, giveninits=true,
  sorting=nyt, sortcites=false, pluralothers=true,% refsection=chapter,
  url=false, dashed=false, mergedate=false
}
% Remove small caps in family names
\DefineBibliographyExtras{french}{\restorecommand\mkbibnamefamily}
\newcommand{\pcite}[1]{\parencite{#1}}

% All citation is hyperlinked
\DeclareFieldFormat{citehyperref}{%
  \DeclareFieldAlias{bibhyperref}{noformat}% Avoid nested links
  \bibhyperref{#1}}

\DeclareFieldFormat{textcitehyperref}{%
  \DeclareFieldAlias{bibhyperref}{noformat}% Avoid nested links
  \bibhyperref{%
    #1%
    \ifbool{cbx:parens}
      {\bibcloseparen\global\boolfalse{cbx:parens}}
      {}}}

\savebibmacro{cite}
\savebibmacro{textcite}

\renewbibmacro*{cite}{%
  \printtext[citehyperref]{%
    \restorebibmacro{cite}%
    \usebibmacro{cite}}}

\renewbibmacro*{textcite}{%
  \ifboolexpr{
    ( not test {\iffieldundef{prenote}} and
      test {\ifnumequal{\value{citecount}}{1}} )
    or
    ( not test {\iffieldundef{postnote}} and
      test {\ifnumequal{\value{citecount}}{\value{citetotal}}} )
  }
    {\DeclareFieldAlias{textcitehyperref}{noformat}}
    {}%
  \printtext[textcitehyperref]{%
    \restorebibmacro{textcite}%
    \usebibmacro{textcite}}}

\sisetup{mode=text, locale=FR}
\DeclareSIUnit\mgm{\milli\gram\per\cubic\metre}
\DeclareSIUnit\dC{\degreeCelsius}

\hypersetup{
  hidelinks,
  draft = false,
  unicode = true,
  linktoc = section,
}

\AtEndPreamble{
  \hypersetup{
    pdftitle={\Title},
    pdfauthor={\Author, \Email},
    pdfsubject={\Subject},
    pdfkeywords={\Keywords}
  }
}

\glsaddall
\makeglossaries
\loadglsentries{gloss}

\newcommand{\articleTitle}{Satellite data reveal earlier and stronger phytoplankton blooms over fronts in the Gulf Stream region}
\newcommand{\articleCceTitle}{Multi-trophic planktonic responses to fronts in a coastal upwelling ecosystem}
\newcommand{\articleReviewTitle}{Impact of submesoscale processes on biogeochemical cycles in a changing ocean}

\newcommand{\biblio}{{
    \emergencystretch=1em
    \printbibliography
  }}

\begin{document}

\ifSubfilesClassLoaded{}{\dominitoc}

% Page de garde
% Résumé
% Remerciements
\include{tex/front_matter}

\printglossary[toctitle=Glossaire]

% TOC
\clearpage
\maketoc
% \listoffigures
% \newpage
% \listoftables

\mainmatter

\subfile{tex/intro}
\subfile{tex/méthodes}
\subfile{tex/res_chl}
\subfile{tex/res_phénologie}
\subfile{tex/conclusion}


\begin{appendices}

\chapter{Article: \articleCceTitle}
\label[appendix]{ax:article-cce}

\chapter{Article: \articleReviewTitle}
\label[appendix]{ax:article-review}

\end{appendices}

\emergencystretch=1em
\chapter*{Bibliographie}
\addcontentsline{toc}{chapter}{Bibliographie}
\printbibliography[heading=none]

\backmatter

\end{document}
